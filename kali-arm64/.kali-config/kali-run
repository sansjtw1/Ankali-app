#!/bin/sh

# è®¾ç½®é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # æ²¡æœ‰é¢œè‰²

# è®¾ç½®ç¬¦å·
ERROR="[-]"
SUCCESS="[+]"
INFO="[*]"

# è®¾ç½®æ—¥å¿—æ–‡ä»¶è·¯å¾„
LOG_DIR="/.kali-config/log"
mkdir -p "$LOG_DIR"
LOG_FILE="$LOG_DIR/$(date +'%Y-%m-%d').log"

# è®°å½•æ—¥å¿—å‡½æ•°
log_message() {
    echo "$1" >> "$LOG_FILE"
}

# è¯»å–é…ç½®æ–‡ä»¶
CONFIG_FILE="/.kali-config/Ankali.conf"
LANGUAGE_CONF="/.kali-config/language.conf"

if [ ! -f "$CONFIG_FILE" ]; then
    log_message "${ERROR} Configuration file $CONFIG_FILE does not exist."
    echo -e "${RED}${ERROR} Configuration file $CONFIG_FILE does not exist.${NC}"
    exit 1
fi

# è·å– INITIALIZATION é…ç½®
INITIALIZATION=$(grep '^INITIALIZATION=' "$CONFIG_FILE" | cut -d'=' -f2)

log_message "${INFO} Initial value of INITIALIZATION: $INITIALIZATION"

treaty_first(){
echo "ä½¿ç”¨å‰è¯·è¯¦ç»†é˜…è¯»ï¼Œå¦‚æœä½ ä½¿ç”¨æ­¤è½¯ä»¶åˆ™é»˜è®¤åŒæ„ä»¥ä¸‹æ¡çº¦(ç‚¹å‡»é“¾æ¥è·³è½¬):
Please read it carefully before using it. If you use this software, you agree to the following treaties by default(Click the link to jump):
- å…è´£å£°æ˜: https://gitee.com/sansjtw/Ankali-app/blob/master/å…è´£å£°æ˜.md

- éšç§æ¡çº¦: https://gitee.com/sansjtw/Ankali-app/blob/master/éšç§æ¡çº¦.md

- Disclaimer: https://github.com/sansjtw1/Ankali-app/blob/master/Disclaimer.md

- Privacy Policy: https://github.com/sansjtw1/Ankali-app/blob/master/Privacy%20Policy.md
"
echo
echo "æˆ‘å·²é˜…è¯»ï¼Œå›è½¦ç»§ç»­"
echo "I've read it. Go back and continue."
read var1 var2 var3 || {
    echo "Error: Not enough input provided."
    exit 1
}
}

if [ "$INITIALIZATION" = "false" ] || [ -z "$INITIALIZATION" ]; then
    treaty_first
    while true; do
        log_message "${INFO} INITIALIZATION is false or unknown. Asking user for language selection."

        echo -e "${YELLOW}${INFO} Please select language:${NC}"
        echo "y) English"
        echo "n) ç®€ä½“ä¸­æ–‡"
        read -p "Choose (y/n): " choice

        if [ "$choice" = "y" ]; then
            log_message "${SUCCESS} User selected English."
            echo -e "${GREEN}${SUCCESS} User selected English.${NC}"
            echo "LANG=en_US.UTF-8" > "$LANGUAGE_CONF"
            echo "LANGUAGE=en_US:en" >> "$LANGUAGE_CONF"
            log_message "${INFO} Language configuration written to $LANGUAGE_CONF."

            # æ›´æ–° Ankali.conf ä¸­çš„ INITIALIZATION å’Œ LANGUAGE
            sed -i 's/^INITIALIZATION=false/INITIALIZATION=true/' "$CONFIG_FILE"
            sed -i 's/^LANGUAGE=.*/LANGUAGE=EN/' "$CONFIG_FILE" || echo "LANGUAGE=EN" >> "$CONFIG_FILE"
            log_message "${SUCCESS} INITIALIZATION set to true, LANGUAGE set to EN."

            # æ‰§è¡Œè‹±æ–‡è„šæœ¬
            /.kali-config/kali_conf
            break
        elif [ "$choice" = "n" ]; then
            log_message "${SUCCESS} User selected Chinese."
            echo -e "${GREEN}${SUCCESS} User selected Chinese.${NC}"
            echo "LANG=zh_CN.UTF-8" > "$LANGUAGE_CONF"
            echo "LANGUAGE=zh_CN:zh:en_US:en" >> "$LANGUAGE_CONF"
            log_message "${INFO} Language configuration written to $LANGUAGE_CONF."

            # æ›´æ–° Ankali.conf ä¸­çš„ INITIALIZATION å’Œ LANGUAGE
            sed -i 's/^INITIALIZATION=false/INITIALIZATION=true/' "$CONFIG_FILE"
            sed -i 's/^LANGUAGE=.*/LANGUAGE=CN/' "$CONFIG_FILE" || echo "LANGUAGE=CN" >> "$CONFIG_FILE"
            log_message "${SUCCESS} INITIALIZATION set to true, LANGUAGE set to CN."

            # æ‰§è¡Œä¸­æ–‡è„šæœ¬
            /.kali-config/kali_conf_cn
            break
        else
            log_message "${ERROR} Invalid selection: $choice. Asking user to select again."
            echo -e "${RED}${ERROR} Invalid selection. Please try again.${NC}"
        fi
    done
elif [ "$INITIALIZATION" = "true" ]; then
    LANGUAGE=$(grep '^LANGUAGE=' "$CONFIG_FILE" | cut -d'=' -f2)
    log_message "${INFO} INITIALIZATION is true, LANGUAGE: $LANGUAGE"

    if [ "$LANGUAGE" = "EN" ]; then
        log_message "${INFO} Executing English script: /.kali-config/kali_conf"
        /.kali-config/kali_conf
    elif [ "$LANGUAGE" = "CN" ]; then
        log_message "${INFO} Executing Chinese script: /.kali-config/kali_conf_cn"
        /.kali-config/kali_conf_cn
    else
        log_message "${ERROR} LANGUAGE is unknown or missing. Resetting INITIALIZATION to false."
        sed -i 's/^INITIALIZATION=true/INITIALIZATION=false/' "$CONFIG_FILE"
        exec "$0"
    fi
else
    log_message "${ERROR} INITIALIZATION configuration is invalid. Resetting to false."
    sed -i 's/^INITIALIZATION=.*/INITIALIZATION=false/' "$CONFIG_FILE" || echo "INITIALIZATION=false" >> "$CONFIG_FILE"
    exec "$0"
fi

# Â©Sansjtw Ankali
# Give yourself a gift for being 16 years old.ğŸÙ©(^á´—^)Û¶